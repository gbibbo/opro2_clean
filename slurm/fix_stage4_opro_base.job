#!/bin/bash
#SBATCH --job-name=fix_stage4_opro_base
#SBATCH --partition=3090
#SBATCH --gpus=1
#SBATCH --cpus-per-task=12
#SBATCH --mem=48G
#SBATCH --time=04:00:00
#SBATCH --exclude=aisurrey14,aisurrey19
#SBATCH --output=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/fix_stage4_%j.out
#SBATCH --error=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/fix_stage4_%j.err

# =============================================================================
# FIX Stage 4: OPRO Open on BASE Model (Re-execution)
# =============================================================================
# Ejecuta OPRO con open-ended prompts en el modelo BASE (sin LoRA)
# =============================================================================

set -euo pipefail
set -x

REPO_CLEAN="/mnt/fast/nobackup/users/gb0048/opro2_clean"
REPO_DATA="/mnt/fast/nobackup/users/gb0048/opro2"
CONTAINER="$REPO_DATA/qwen_pipeline_v2.sif"
SEED=42

echo "[INFO] ========================================================================"
echo "[INFO] FIX STAGE 4: OPRO Open on BASE - INICIO: $(date)"
echo "[INFO] ========================================================================"
echo "[INFO] Seed: $SEED"
echo "[INFO] GPU Info:"
nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv
echo "[INFO] Node: $(hostname)"
echo "[INFO] ========================================================================"

cd "$REPO_CLEAN"

# Configurar cache de HuggingFace
export HF_HOME="/mnt/fast/nobackup/users/gb0048/.cache/huggingface"
export TRANSFORMERS_CACHE="$HF_HOME/transformers"
export HF_HUB_CACHE="$HF_HOME/hub"
mkdir -p "$HF_HOME" "$TRANSFORMERS_CACHE" "$HF_HUB_CACHE"

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# Rutas
DATA_ROOT="$REPO_DATA/data"
OUTPUT_DIR="results/complete_pipeline_seed${SEED}_opro_open/04_opro_base"
DEV_CSV="$DATA_ROOT/processed/experimental_variants/dev_metadata.csv"

# Verificar container
if [ ! -f "$CONTAINER" ]; then
    echo "[ERROR] Container not found: $CONTAINER"
    exit 1
fi

# Limpiar output anterior
echo "[INFO] Limpiando output anterior..."
rm -rf "$OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR"

# Test CUDA
echo "[INFO] ========================================================================"
echo "[INFO] Testing CUDA availability inside container..."
echo "[INFO] ========================================================================"

apptainer exec --nv \
    --pwd "$REPO_CLEAN" \
    --env HF_HOME="$HF_HOME" \
    "$CONTAINER" python3 -c "
import torch
print(f'CUDA available: {torch.cuda.is_available()}')
if torch.cuda.is_available():
    print(f'CUDA device: {torch.cuda.get_device_name(0)}')
    x = torch.randn(10, 10).cuda()
    print(f'Test tensor on GPU: {x.device}')
    print('CUDA test: ✓ PASSED')
else:
    print('ERROR: CUDA not available!')
    exit(1)
"

CUDA_TEST_EXIT=$?
if [ $CUDA_TEST_EXIT -ne 0 ]; then
    echo "[ERROR] ✗ CUDA test failed. Aborting job."
    exit 1
fi

echo "[INFO] ✓ CUDA test passed. Proceeding with Stage 4..."

# Ejecutar Stage 4: OPRO Open en modelo BASE
echo "[INFO] ========================================================================"
echo "[INFO] Ejecutando Stage 4: OPRO Open on BASE model"
echo "[INFO] ========================================================================"

apptainer exec --nv \
    --pwd "$REPO_CLEAN" \
    --env HF_HOME="$HF_HOME" \
    --env TRANSFORMERS_CACHE="$TRANSFORMERS_CACHE" \
    --env HF_HUB_CACHE="$HF_HUB_CACHE" \
    --env PYTORCH_CUDA_ALLOC_CONF="$PYTORCH_CUDA_ALLOC_CONF" \
    "$CONTAINER" python3 scripts/opro_post_ft_v2.py \
        --no_lora \
        --train_csv "$DEV_CSV" \
        --output_dir "$OUTPUT_DIR" \
        --num_iterations 15 \
        --samples_per_iter 20 \
        --num_candidates 8 \
        --seed "$SEED" \
        --decoding open

EXIT_CODE=$?

echo "[INFO] ========================================================================"
if [ $EXIT_CODE -eq 0 ]; then
    echo "[INFO] ✓ Stage 4 COMPLETED SUCCESSFULLY"
    echo "[INFO] Output: $OUTPUT_DIR"
    echo "[INFO] Best prompt: $OUTPUT_DIR/best_prompt.txt"
    if [ -f "$OUTPUT_DIR/best_prompt.txt" ]; then
        echo "[INFO] Best prompt content:"
        cat "$OUTPUT_DIR/best_prompt.txt"
    fi
else
    echo "[ERROR] ✗ Stage 4 FAILED (Exit code: $EXIT_CODE)"
fi
echo "[INFO] FIN: $(date)"
echo "[INFO] ========================================================================"

exit $EXIT_CODE
