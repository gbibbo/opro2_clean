#!/bin/bash
#SBATCH --job-name=fix_stage5_opro_lora
#SBATCH --partition=3090
#SBATCH --gpus=1
#SBATCH --cpus-per-task=12
#SBATCH --mem=48G
#SBATCH --time=04:00:00
#SBATCH --exclude=aisurrey14
#SBATCH --output=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/fix_stage5_%j.out
#SBATCH --error=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/fix_stage5_%j.err

# =============================================================================
# FIX Stage 5: OPRO on LoRA Model (Re-execution)
# =============================================================================
# Re-ejecuta solo Stage 5 que falló por errores de CUDA
# Usa el mismo contenedor pero en un job individual
# =============================================================================

set -euo pipefail
set -x

REPO_CLEAN="/mnt/fast/nobackup/users/gb0048/opro2_clean"
REPO_DATA="/mnt/fast/nobackup/users/gb0048/opro2"
CONTAINER="$REPO_DATA/qwen_pipeline_v2.sif"
SEED=42

echo "[INFO] ========================================================================"
echo "[INFO] FIX STAGE 5: OPRO on LoRA - INICIO: $(date)"
echo "[INFO] ========================================================================"
echo "[INFO] Seed: $SEED"
echo "[INFO] GPU Info:"
nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv
echo "[INFO] Node: $(hostname)"
echo "[INFO] ========================================================================"

cd "$REPO_CLEAN"

# Configurar cache de HuggingFace
export HF_HOME="/mnt/fast/nobackup/users/gb0048/.cache/huggingface"
export TRANSFORMERS_CACHE="$HF_HOME/transformers"
export HF_HUB_CACHE="$HF_HOME/hub"
mkdir -p "$HF_HOME" "$TRANSFORMERS_CACHE" "$HF_HUB_CACHE"

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# Rutas
DATA_ROOT="$REPO_DATA/data"
CHECKPOINT="checkpoints/qwen_lora_seed${SEED}/final"
OUTPUT_DIR="results/complete_pipeline_seed${SEED}_opro_open/05_opro_lora"
DEV_CSV="$DATA_ROOT/processed/experimental_variants/dev_metadata.csv"

# Verificar container y checkpoint
if [ ! -f "$CONTAINER" ]; then
    echo "[ERROR] Container not found: $CONTAINER"
    exit 1
fi

if [ ! -d "$CHECKPOINT" ]; then
    echo "[ERROR] Checkpoint not found: $CHECKPOINT"
    exit 1
fi

# Limpiar output anterior (para forzar re-generación limpia)
echo "[INFO] Limpiando output anterior..."
rm -rf "$OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR"

# Test rápido de CUDA dentro del contenedor
echo "[INFO] ========================================================================"
echo "[INFO] Testing CUDA availability inside container..."
echo "[INFO] ========================================================================"

apptainer exec --nv \
    --pwd "$REPO_CLEAN" \
    --env HF_HOME="$HF_HOME" \
    "$CONTAINER" python3 -c "
import torch
print(f'CUDA available: {torch.cuda.is_available()}')
if torch.cuda.is_available():
    print(f'CUDA device count: {torch.cuda.device_count()}')
    print(f'CUDA device 0: {torch.cuda.get_device_name(0)}')
    print(f'CUDA version: {torch.version.cuda}')
    # Test tensor allocation
    x = torch.randn(10, 10).cuda()
    print(f'Test tensor on GPU: {x.device}')
    print('CUDA test: ✓ PASSED')
else:
    print('ERROR: CUDA not available!')
    exit(1)
"

CUDA_TEST_EXIT=$?
if [ $CUDA_TEST_EXIT -ne 0 ]; then
    echo "[ERROR] ✗ CUDA test failed. Aborting job."
    exit 1
fi

echo "[INFO] ✓ CUDA test passed. Proceeding with Stage 5..."

# Ejecutar Stage 5: OPRO en LoRA
echo "[INFO] ========================================================================"
echo "[INFO] Ejecutando Stage 5: OPRO on LoRA model"
echo "[INFO] ========================================================================"

apptainer exec --nv \
    --pwd "$REPO_CLEAN" \
    --env HF_HOME="$HF_HOME" \
    --env TRANSFORMERS_CACHE="$TRANSFORMERS_CACHE" \
    --env HF_HUB_CACHE="$HF_HUB_CACHE" \
    --env PYTORCH_CUDA_ALLOC_CONF="$PYTORCH_CUDA_ALLOC_CONF" \
    "$CONTAINER" python3 scripts/opro_post_ft_v2.py \
        --checkpoint "$CHECKPOINT" \
        --train_csv "$DEV_CSV" \
        --output_dir "$OUTPUT_DIR" \
        --num_iterations 15 \
        --samples_per_iter 20 \
        --num_candidates 8 \
        --seed "$SEED"

EXIT_CODE=$?

echo "[INFO] ========================================================================"
if [ $EXIT_CODE -eq 0 ]; then
    echo "[INFO] ✓ Stage 5 COMPLETED SUCCESSFULLY"
    echo "[INFO] Output: $OUTPUT_DIR"
    echo "[INFO] Best prompt: $OUTPUT_DIR/best_prompt.txt"
    if [ -f "$OUTPUT_DIR/best_prompt.txt" ]; then
        echo "[INFO] Best prompt content:"
        cat "$OUTPUT_DIR/best_prompt.txt"
    fi
else
    echo "[ERROR] ✗ Stage 5 FAILED (Exit code: $EXIT_CODE)"
fi
echo "[INFO] FIN: $(date)"
echo "[INFO] ========================================================================"

exit $EXIT_CODE
