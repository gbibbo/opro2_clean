#!/bin/bash
#SBATCH --job-name=reeval_qwen3
#SBATCH --partition=a100
#SBATCH --gpus=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G
#SBATCH --time=06:00:00
#SBATCH --output=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/reeval_qwen3_omni_%j.out
#SBATCH --error=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/reeval_qwen3_omni_%j.err

# =============================================================================
# Re-evaluation of Qwen3-Omni with OPRO-optimized prompt on TEST set
# =============================================================================

set -euo pipefail
set -x

REPO_CLEAN="/mnt/fast/nobackup/users/gb0048/opro2_clean"
REPO_DATA="/mnt/fast/nobackup/users/gb0048/opro2"
CONTAINER="$REPO_DATA/pytorch_2.1_cuda12.sif"

echo "[INFO] Start: $(date)"
nvidia-smi --query-gpu=name,memory.total --format=csv
cd "$REPO_CLEAN"

export HF_HOME="/mnt/fast/nobackup/users/gb0048/.cache/huggingface"
export TRANSFORMERS_CACHE="$HF_HOME/transformers"
export HF_HUB_CACHE="$HF_HOME/hub"
export PIP_CACHE_DIR="/mnt/fast/nobackup/users/gb0048/.cache/pip"
export TMPDIR="/mnt/fast/nobackup/users/gb0048/tmp"
mkdir -p "$HF_HOME" "$TRANSFORMERS_CACHE" "$HF_HUB_CACHE" "$PIP_CACHE_DIR" "$TMPDIR"
mkdir -p logs

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# Test manifest
TEST_MANIFEST="$REPO_DATA/data/processed/variants_validated_1000/test_metadata.csv"

# OPRO best prompt
OPRO_PROMPT_FILE="$REPO_CLEAN/results/opro_qwen3_omni_seed42/best_prompt.txt"

if [ ! -f "$TEST_MANIFEST" ]; then
    echo "[ERROR] Test manifest not found: $TEST_MANIFEST"
    exit 1
fi

if [ ! -f "$OPRO_PROMPT_FILE" ]; then
    echo "[ERROR] OPRO prompt file not found: $OPRO_PROMPT_FILE"
    exit 1
fi

if [ ! -f "$CONTAINER" ]; then
    echo "[ERROR] Container not found: $CONTAINER"
    exit 1
fi

# Symlink for audio paths
if [ ! -L "$REPO_CLEAN/data" ] && [ ! -d "$REPO_CLEAN/data" ]; then
    ln -s "$REPO_DATA/data" "$REPO_CLEAN/data"
    echo "[SETUP] Created symlink: $REPO_CLEAN/data -> $REPO_DATA/data"
fi

# Install dependencies
echo "[SETUP] Installing dependencies..."
apptainer exec --nv \
  --env PIP_CACHE_DIR="$PIP_CACHE_DIR" \
  --env TMPDIR="$TMPDIR" \
  "$CONTAINER" pip install --user --upgrade \
  "https://github.com/huggingface/transformers/archive/refs/heads/main.tar.gz" \
  accelerate pyarrow librosa soundfile peft

export TRANSFORMERS_UPDATED=1

echo "[RUN] Re-evaluating Qwen3-Omni on TEST set with OPRO prompt"
echo "  Prompt: $(cat $OPRO_PROMPT_FILE)"

apptainer exec --nv \
  --pwd "$REPO_CLEAN" \
  --env HF_HOME="$HF_HOME" \
  --env TRANSFORMERS_CACHE="$TRANSFORMERS_CACHE" \
  --env HF_HUB_CACHE="$HF_HUB_CACHE" \
  --env PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True" \
  --env TRANSFORMERS_UPDATED=1 \
  "$CONTAINER" python3 scripts/evaluate_simple.py \
  --manifest "$TEST_MANIFEST" \
  --prompt_file "$OPRO_PROMPT_FILE" \
  --output_dir "results/reeval_qwen3_omni_opro_test" \
  --model_type qwen3_omni \
  --batch_size 50

echo "[DONE] End: $(date)"
echo "Results: results/reeval_qwen3_omni_opro_test/"