#!/bin/bash
#SBATCH --job-name=fix_stage7_eval
#SBATCH --partition=3090
#SBATCH --gpus=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G
#SBATCH --time=03:00:00
#SBATCH --exclude=aisurrey14
#SBATCH --output=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/fix_stage7_%j.out
#SBATCH --error=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/fix_stage7_%j.err

# =============================================================================
# FIX Stage 7: Evaluate LoRA + OPRO (Re-execution)
# =============================================================================
# Re-ejecuta solo Stage 7 después de que Stage 5 se complete exitosamente
# =============================================================================

set -euo pipefail
set -x

REPO_CLEAN="/mnt/fast/nobackup/users/gb0048/opro2_clean"
REPO_DATA="/mnt/fast/nobackup/users/gb0048/opro2"
CONTAINER="$REPO_DATA/qwen_pipeline_v2.sif"
SEED=42

echo "[INFO] ========================================================================"
echo "[INFO] FIX STAGE 7: Eval LoRA + OPRO - INICIO: $(date)"
echo "[INFO] ========================================================================"
echo "[INFO] Seed: $SEED"
echo "[INFO] GPU Info:"
nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv
echo "[INFO] Node: $(hostname)"
echo "[INFO] ========================================================================"

cd "$REPO_CLEAN"

# Configurar cache de HuggingFace
export HF_HOME="/mnt/fast/nobackup/users/gb0048/.cache/huggingface"
export TRANSFORMERS_CACHE="$HF_HOME/transformers"
export HF_HUB_CACHE="$HF_HOME/hub"
mkdir -p "$HF_HOME" "$TRANSFORMERS_CACHE" "$HF_HUB_CACHE"

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# Rutas
DATA_ROOT="$REPO_DATA/data"
CHECKPOINT="checkpoints/qwen_lora_seed${SEED}/final"
OUTPUT_DIR="results/complete_pipeline_seed${SEED}_opro_open/07_eval_lora_opro"
TEST_MANIFEST="$DATA_ROOT/processed/variants_validated_1000/test_metadata.csv"
BEST_PROMPT="results/complete_pipeline_seed${SEED}_opro_open/05_opro_lora/best_prompt.txt"

# Verificar prerequisites
if [ ! -f "$CONTAINER" ]; then
    echo "[ERROR] Container not found: $CONTAINER"
    exit 1
fi

if [ ! -d "$CHECKPOINT" ]; then
    echo "[ERROR] Checkpoint not found: $CHECKPOINT"
    exit 1
fi

if [ ! -f "$BEST_PROMPT" ]; then
    echo "[ERROR] Best prompt not found: $BEST_PROMPT"
    echo "[ERROR] Stage 5 must complete successfully first!"
    exit 1
fi

echo "[INFO] Best prompt to evaluate:"
cat "$BEST_PROMPT"
echo ""

# Limpiar output anterior
echo "[INFO] Limpiando output anterior..."
rm -rf "$OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR"

# Test CUDA
echo "[INFO] ========================================================================"
echo "[INFO] Testing CUDA availability inside container..."
echo "[INFO] ========================================================================"

apptainer exec --nv \
    --pwd "$REPO_CLEAN" \
    --env HF_HOME="$HF_HOME" \
    "$CONTAINER" python3 -c "
import torch
print(f'CUDA available: {torch.cuda.is_available()}')
if torch.cuda.is_available():
    print(f'CUDA device: {torch.cuda.get_device_name(0)}')
    x = torch.randn(10, 10).cuda()
    print(f'Test tensor on GPU: {x.device}')
    print('CUDA test: ✓ PASSED')
else:
    print('ERROR: CUDA not available!')
    exit(1)
"

CUDA_TEST_EXIT=$?
if [ $CUDA_TEST_EXIT -ne 0 ]; then
    echo "[ERROR] ✗ CUDA test failed. Aborting job."
    exit 1
fi

echo "[INFO] ✓ CUDA test passed. Proceeding with Stage 7..."

# Ejecutar Stage 7: Evaluación LoRA + OPRO
echo "[INFO] ========================================================================"
echo "[INFO] Ejecutando Stage 7: Evaluate LoRA + OPRO"
echo "[INFO] ========================================================================"

apptainer exec --nv \
    --pwd "$REPO_CLEAN" \
    --env HF_HOME="$HF_HOME" \
    --env TRANSFORMERS_CACHE="$TRANSFORMERS_CACHE" \
    --env HF_HUB_CACHE="$HF_HUB_CACHE" \
    --env PYTORCH_CUDA_ALLOC_CONF="$PYTORCH_CUDA_ALLOC_CONF" \
    "$CONTAINER" python3 scripts/evaluate_simple.py \
        --manifest "$TEST_MANIFEST" \
        --prompt_file "$BEST_PROMPT" \
        --checkpoint "$CHECKPOINT" \
        --output_dir "$OUTPUT_DIR" \
        --batch_size 50

EXIT_CODE=$?

echo "[INFO] ========================================================================"
if [ $EXIT_CODE -eq 0 ]; then
    echo "[INFO] ✓ Stage 7 COMPLETED SUCCESSFULLY"
    echo "[INFO] Output: $OUTPUT_DIR"

    if [ -f "$OUTPUT_DIR/metrics.json" ]; then
        echo "[INFO] Metrics:"
        cat "$OUTPUT_DIR/metrics.json" | python3 -m json.tool | grep -E "ba_clip|ba_conditions|speech_acc|nonspeech_acc" | head -10
    fi
else
    echo "[ERROR] ✗ Stage 7 FAILED (Exit code: $EXIT_CODE)"
fi
echo "[INFO] FIN: $(date)"
echo "[INFO] ========================================================================"

exit $EXIT_CODE
