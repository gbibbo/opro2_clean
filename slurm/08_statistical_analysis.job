#!/bin/bash
#SBATCH --job-name=stats_analysis
#SBATCH --output=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/08_statistical_analysis_%j.out
#SBATCH --error=/mnt/fast/nobackup/users/gb0048/opro2_clean/logs/08_statistical_analysis_%j.err
#SBATCH --partition=3090
#SBATCH --gres=gpu:0
#SBATCH --cpus-per-task=16
#SBATCH --mem=64G
#SBATCH --time=12:00:00

# =============================================================================
# Statistical Analysis Job
# =============================================================================
# Runs rigorous statistical analysis on all model predictions
# Performs 4 primary comparisons with McNemar + Holm-Bonferroni correction
# Bootstrap CI (10,000 resamples) for BA and ΔBA
# Usage: sbatch slurm/08_statistical_analysis.job
# =============================================================================

set -euo pipefail
set -x

SEED=42
REPO_CLEAN="/mnt/fast/nobackup/users/gb0048/opro2_clean"
REPO_DATA="/mnt/fast/nobackup/users/gb0048/opro2"
CONTAINER="$REPO_DATA/qwen_pipeline_v2.sif"

echo "========================================================================"
echo "Statistical Analysis - Complete"
echo "========================================================================"
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $SLURMD_NODENAME"
echo "Start time: $(date)"
echo ""

cd "$REPO_CLEAN"
mkdir -p logs
mkdir -p results/statistical_analysis

# Define prediction file paths
BASELINE="${REPO_CLEAN}/results/complete_pipeline_seed42/01_baseline/predictions.csv"
LORA="${REPO_CLEAN}/results/complete_pipeline_seed42/03_eval_lora/predictions.csv"
BASE_OPRO="${REPO_CLEAN}/results/complete_pipeline_seed42/06_eval_base_opro/predictions.csv"
LORA_OPRO="${REPO_CLEAN}/results/complete_pipeline_seed42/07_eval_lora_opro/predictions.csv"
LORA_OPRO_OPEN="${REPO_CLEAN}/results/complete_pipeline_seed42_opro_open/07_eval_lora_opro/predictions.csv"

OUTPUT_DIR="${REPO_CLEAN}/results/statistical_analysis"

echo "Checking prediction files..."
for FILE in "$BASELINE" "$LORA" "$BASE_OPRO" "$LORA_OPRO" "$LORA_OPRO_OPEN"; do
    if [ -f "$FILE" ]; then
        echo "  ✓ $FILE"
    else
        echo "  ✗ MISSING: $FILE"
        exit 1
    fi
done
echo ""

echo "Running statistical analysis..."
echo "  Primary comparisons: 4"
echo "    1. Baseline vs Base+OPRO"
echo "    2. Baseline vs LoRA+BasePrompt"
echo "    3. LoRA+BasePrompt vs LoRA+OPRO"
echo "    4. LoRA+OPRO_Classic vs LoRA+OPRO_Open"
echo ""
echo "  Bootstrap samples: 10,000"
echo "  Random seed: ${SEED}"
echo "  Output: ${OUTPUT_DIR}"
echo ""

apptainer exec \
    --pwd "$REPO_CLEAN" \
    "$CONTAINER" python3 scripts/statistical_analysis.py \
    --baseline "${BASELINE}" \
    --lora "${LORA}" \
    --base_opro "${BASE_OPRO}" \
    --lora_opro "${LORA_OPRO}" \
    --lora_opro_open "${LORA_OPRO_OPEN}" \
    --output_dir "${OUTPUT_DIR}" \
    --n_bootstrap 10000 \
    --seed ${SEED}

EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    echo ""
    echo "========================================================================"
    echo "Statistical Analysis COMPLETED"
    echo "========================================================================"
    echo "Results saved to: ${OUTPUT_DIR}"
    echo "  - statistical_analysis.json (machine-readable)"
    echo "  - statistical_report.txt (human-readable)"
    echo ""
    echo "End time: $(date)"
else
    echo ""
    echo "ERROR: Statistical analysis failed with exit code ${EXIT_CODE}"
    exit ${EXIT_CODE}
fi
